<!DOCTYPE html>
<html>
<head>

  <!-- Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="x-ua-compatible" content="ie=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

  <!-- Browser-friendly :) -->
  <meta name="description" content="Test forms for HG">
  <title>HG test forms</title>

  <!-- App icons & favicons -->
  <link rel="apple-touch-icon" sizes="57x57" href="./icons/apple-icon-57x57.png">
  <link rel="apple-touch-icon" sizes="60x60" href="./icons/apple-icon-60x60.png">
  <link rel="apple-touch-icon" sizes="72x72" href="./icons/apple-icon-72x72.png">
  <link rel="apple-touch-icon" sizes="76x76" href="./icons/apple-icon-76x76.png">
  <link rel="apple-touch-icon" sizes="114x114" href="./icons/apple-icon-114x114.png">
  <link rel="apple-touch-icon" sizes="120x120" href="./icons/apple-icon-120x120.png">
  <link rel="apple-touch-icon" sizes="144x144" href="./icons/apple-icon-144x144.png">
  <link rel="apple-touch-icon" sizes="152x152" href="./icons/apple-icon-152x152.png">
  <link rel="apple-touch-icon" sizes="180x180" href="./icons/apple-icon-180x180.png">
  <link rel="icon" type="image/png" sizes="192x192"  href="./icons/android-icon-192x192.png">
  <link rel="icon" type="image/png" sizes="32x32" href="./icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="96x96" href="./icons/favicon-96x96.png">
  <link rel="icon" type="image/png" sizes="16x16" href="./icons/favicon-16x16.png">
  <link rel="manifest" href="./icons/manifest.json">
  <meta name="msapplication-TileColor" content="#ffffff">
  <meta name="msapplication-TileImage" content="./icons/ms-icon-144x144.png">
  <meta name="theme-color" content="#ffffff">

  <!-- Bower stuff -->
  <link rel="stylesheet" href="bower_components/bootstrap/dist/css/bootstrap.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-select/dist/css/bootstrap-select.min.css" />
  <link rel="stylesheet" href="bower_components/bootstrap-datepicker/dist/css/bootstrap-datepicker.min.css" />
  <script src="bower_components/jquery/dist/jquery.min.js"></script>
  <script src="bower_components/bootstrap/dist/js/bootstrap.js"></script>
  <script src="bower_components/bootstrap-select/dist/js/bootstrap-select.min.js"></script>
  <script src="bower_components/bootstrap-datepicker/dist/js/bootstrap-datepicker.min.js"></script>
  <script src="bower_components/jquery-validation/dist/jquery.validate.min.js"></script>

  <!-- Scripts -->
  <script src="scripts/forms.js"></script>
  <script src="scripts/data.js"></script>

  <!-- The life of the page -->
  <script>
  Date.prototype.dateAdd = function(size,value) {
    var newDate = new Date(this);
    value = parseInt(value);
    var incr = 0;
    switch (size) {
        case 'day':
            incr = value * 24;
            newDate.dateAdd('hour',incr);
            return newDate;
        case 'hour':
            incr = value * 60;
            newDate.dateAdd('minute',incr);
            return newDate;
        case 'week':
            incr = value * 7;
            newDate.dateAdd('day',incr);
            return newDate;
        case 'minute':
            incr = value * 60;
            newDate.dateAdd('second',incr);
            return newDate;
        case 'second':
            incr = value * 1000;
            newDate.dateAdd('millisecond',incr);
            return newDate;
        case 'month':
            value = value + newDate.getUTCMonth();
            if (value/12>0) {
                newDate.dateAdd('year',value/12);
                value = value % 12;
            }
            newDate.setUTCMonth(value);
            return newDate;
        case 'millisecond':
            newDate.setTime(newDate.getTime() + value);
            return newDate;
        case 'year':
            newDate.setFullYear(newDate.getUTCFullYear()+value);
            return newDate;
        default:
            throw new Error('Invalid date increment passed');
            //break;
    }
}; // for later
  // Style Guide: //
  /*
  * When creating an element, prefix it's var name with $
  * Define it with only the minimum valid html tag required for that element - e.g. $("<a></a>")
  * All text content in the element must be added using .html()
  * All attributes are defined using .attr or .addClass
  * All children must be appended to the parent with append or appendTo
  */

  // Define everything here

  // Constants
  var fadeOutTime = 300;
  var fadeInTime = 500;


  // Vars

  /* PARAMETERS FOR STEP():
    * step (step index)
    * noSteps (number of steps)
    * buttonCallback (duh)
    * labelContent (optional)
    * (does not do anything anymore) parentForm
    * content (optional)
    * visible (optional, but reccomended)
    * inputPlaceholder (optional)
    * buttonText (also optional)
  */

  var $form, steps, canPressButton, currentStep, noSteps, $finalForm, $button, $head; // define all variables so they can be accessed through the console (will be changed later for security)

    $(document).ready(function(){
      // Utility functions
      function finish() {
        for (var i = 0; i < steps.length; i ++) {
          steps[i].fadeOut(fadeOutTime);
        }
      }

      function refreshActive(dir) {

        function /* local! */ createAlert(text) { // DRY
          var $alert = $("<div></div>")
            .addClass("alert")
            .addClass("alert-danger")
            .addClass("alert-dismissable")
            .attr("role","alert")
            .append(
              $("<button></button>")
                .addClass("close")
                .attr("type","button")
                .attr("data-dismiss","alert")
                .attr("aria-label","Close")
                .html($("<span></span>").attr("aria-hidden","true").html("&times;"))
            )
            .append(text);
            return $alert;
        }

        function /* local */ nextStep(){ //DRY DRY DRY!!!!
            canPressButton = false; // ugh..
            steps[currentStep].addClass("ignore");
            steps[currentStep].fadeOut(fadeOutTime,function() {
                steps[currentStep].removeClass("ignore");

                canPressButton = true; // yuck..

                currentStep += 1; // incrememt currentStep (yech)

                function /* (local) */ fadeIn() {
                  steps[currentStep].fadeIn(fadeInTime);
                }

                if (currentStep < noSteps) { // make sure we don't get a nil step
                  fadeIn();
                } else {
                  currentStep = steps.length - 1;
                  //complete the form
                  fadeIn();
                }
            }); // increment step. once that is done, fade in the next step
        }

        if ( dir === undefined || dir === 1 ) {

          var allOK = true;
          for (var i = 0; i < data[currentStep].inputs.length; i++) {
          var currentData = data[currentStep].inputs[i];
          var failRegex = currentData.fail;
          if (failRegex !== undefined) {

            var inputValue = $("#input"+(currentStep+1)+"-"+i).val(); // more DRY
            var $alert;
            if (inputValue.match(failRegex)) {
              $alert = createAlert(currentData.messages.error); // create alert with error message
              allOK = false;
            } else if(currentData.required === true && (inputValue === "" || inputValue.match(/^\s+$/))) { // kill nasty empty input fields (if they are required)
              console.log(currentData.messages.empty);
              $alert = createAlert(currentData.messages.empty); // create alert with empty message
              allOK = false;
            }
            steps[currentStep].append("<br />").append($alert === undefined ? "" : $alert); // display alert or nothing if there was no error
          }
        }
        if (allOK) { // need this, otherwise multiple steps will appear out of nowhere!
          nextStep();
        }
        } else {
          canPressButton = false; // ugh..
          steps[currentStep].addClass("ignore");
          steps[currentStep].fadeOut(fadeOutTime,function() {
            steps[currentStep].removeClass("ignore");

            canPressButton = true; // yuck..

            currentStep -= 1; // incrememt currentStep (yech)

            function /* (local) */ fadeIn() {
              steps[currentStep].fadeIn(fadeInTime);
            }

            if (currentStep < noSteps) { // make sure we don't get a nil step
              fadeIn();
            } else {
              currentStep = steps.length - 1;
              //complete the form
              fadeIn();
            }
          }); // increment step. once that is done, fade in the next step
        }
      }
      // end

      $form = $("<form></form>").attr("id","mainForm"); // the form container

      steps = []; // the array that will hold all the steps
      canPressButton = true; // this is sooo ugly.. I wish I could remove it
      currentStep = 0; // I don't know if I need this either
      noSteps = data.length; // the number of steps
      // final area with "submit" button
      $finalForm = $("<div></div>")
        .addClass("form-group")
        .addClass("col-md-6");
      $button = $("<input />")
        .addClass("btn")
        .addClass("btn-success")
        .attr("type","submit")
        .html("Finish")
        .click(finish);
      $head = $("<h4></h4>")
        .html("Thank you for using this form");
      $finalForm
        .append($("<br />"))
        .append($head)
        .append($("<br />"))
        .append($button)
        .fadeOut(0);

      // Main code (time to *do* stuff)
      function defaultCallback(e) {
          e.preventDefault();
          if (canPressButton) {
            console.log("refreshed");
            refreshActive();
          } else {
            console.log(canPressButton);
          }
      }
      function goback(e) {
        e.preventDefault();
        if (canPressButton) {
          refreshActive(-1);
        }
      }


      function createInput(datas, inputs) {
        return {
          inputPlaceholder: datas.customPlaceholder,
          customInputType: datas.customInputType,
          inputRequired: datas.inputRequired,
          labelContent: datas.label,
          fail: datas.fail,
          messages: datas.messages,
          inline: datas.inline
        };
      }

      // Note to self: js arrays start at 0!
      for (var i = 0; i < noSteps; i ++) {
        var inputs = [];
        var currentData;
        if (data[i].inputs !== undefined) { // create multiple
          for (var j = 0; j < data[i].inputs.length; j++) {
            currentData = data[i].inputs[j];
            console.log(currentData.customPlaceholder);
            inputs.push(createInput(currentData));
          }
        } else {
          currentData = data[i];
          inputs.push(createInput(currentData));
          data[i].inputs = [currentData];
        }
        steps[i] = createStep({
          step: i+1, // put this so that steps are shown as index in array + 1
          noSteps: noSteps,
          buttonText: "&gt;&gt;",
          buttonCallback: defaultCallback,
          previousText: i > 0 ? "&lt;&lt;" : undefined,
          previousCallback: goback,// no need for check here; previous is defined by previousText
          content: data[i].contentText === undefined ? "<br />" : data[i].contentText + "<br />",
          //labelContent: data[i].label,
          custom: data[i].custom,
          inputs: inputs
        });
        steps[i].addClass("ignore");
      }

      steps.push($finalForm);

      for (i = 0; i < steps.length; i ++) {
        var $el = steps[i];
        $el.appendTo($form);
      }
      $form.appendTo(".container");
      steps[0].fadeIn(500);

      $form.submit(function(e) { // at last, we intercept the form and gloriously console.log the output!!!
        e.preventDefault();
        var formSubmission = $(this).serializeArray();
        console.log(formSubmission); // for me
        alert(JSON.stringify(formSubmission)); //for mom
      });

      /* Rendering stuff */
      var currentDate = (new Date());

      $("#year-dp").datepicker( {
          format: " yyyy",
          viewMode: "years",
          minViewMode: "years",
          endDate: currentDate,
          startDate: currentDate.dateAdd("year",-2)
      })
      .on("changeDate",function(e){
        var year = e.date.getFullYear();
        $("#sy").html(year+" - "+(year+1));
      });
      $("#year-dp").val(" " + currentDate.getFullYear());
      $("#year-dp").datepicker('update');
      $(".date").datepicker( {
        endDate: currentDate,
        assumeNearbyYear: true
      });
      $('.selectpicker').selectpicker();

    });
  </script>
</head>
<body>
  <div class="container"></div>
  <!-- Just a container; nothing else has to be added here because everything will be added dynamically through script -->
</body>
</html>
